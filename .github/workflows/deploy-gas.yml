name: Deploy Google Apps Script (single repo, auto-bootstrap)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # allow committing .clasp.json back

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # so we can push commits back

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp (3.x)
        run: npm install -g @google/clasp@^3.1.0

      - name: Restore clasp credentials from secret
        run: |
          mkdir -p ~
          cat << 'JSON' > ~/.clasprc.json
          ${{ secrets.CLASPRC_JSON }}
          JSON

      - name: Check clasp login status
        run: clasp login --status

      # Create Apps Script project if we don't have a real scriptId yet
      - name: Ensure Apps Script project exists
        run: |
          if [ ! -f .clasp.json ] || grep -q "YOUR_SCRIPT_ID_HERE" .clasp.json; then
            echo "No real scriptId yet – creating a new Apps Script project with clasp..."
            # Change title/type if you want
            clasp create --title "clasp-from-fresh" --type standalone

            echo "Resulting .clasp.json:"
            cat .clasp.json
          else
            echo ".clasp.json already has a scriptId – skipping create."
          fi

      # Commit the generated/updated .clasp.json back to the repo (first run)
      - name: Commit .clasp.json with scriptId
        run: |
          if git status --porcelain .clasp.json | grep -q .; then
            echo "Committing updated .clasp.json back to the repo..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .clasp.json
            git commit -m "Add/Update .clasp.json scriptId [skip ci]" || echo "Nothing to commit"
            git push
          else
            echo "No changes to .clasp.json – nothing to commit."
          fi

      - name: Deploy Apps Script project
        run: clasp push -f
